<h2 mat-dialog-title>{{ titulo }}</h2>

<mat-dialog-content>
  <form [formGroup]="form" class="form-wrap">

    <mat-form-field appearance="outline" class="full">
      <mat-label>Cliente</mat-label>
      <mat-select formControlName="clienteId">

        <mat-option>
          <ngx-mat-select-search
            [formControl]="filtroClientesCtrl"
            placeholderLabel="Buscar cliente..."
            noEntriesFoundLabel="Sin resultados">
          </ngx-mat-select-search>
        </mat-option>

        <mat-option *ngIf="cargandoClientes" [disabled]="true">
          Cargando clientes...
        </mat-option>

        <mat-option *ngFor="let c of clientesFiltrados" [value]="c.id">
          {{ c.razonSocial }}
        </mat-option>
      </mat-select>

      <mat-error *ngIf="form.get('clienteId')?.hasError('required')">
        Seleccioná un cliente
      </mat-error>
    </mat-form-field>

    <div class="lineas-header">
      <h3>Ítems</h3>
      <button mat-stroked-button color="primary" type="button" (click)="agregarLinea()">
        <mat-icon>add</mat-icon>
        Agregar ítem
      </button>
    </div>

    <div class="tabla-lineas">

      <div class="fila cabecera">
        <div class="col item">Ítem</div>
        <div class="col cantidad">Cant. Comercial</div>
        <div class="col cantidad">Cantidad Base</div>
        <div class="col precio">Precio</div>
        <div class="col subtotal">Subtotal</div>
        <div class="col acciones">Acciones</div>
      </div>

      <div class="fila" *ngFor="let det of detalles.controls; let i = index" [formGroup]="det">

        <!-- ITEM -->
        <div class="col item">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Producto / Servicio</mat-label>

            <mat-select formControlName="itemId" (selectionChange)="onItemChange(i)">
              <mat-option>
                <ngx-mat-select-search
                  [formControl]="filtroItemsCtrl"
                  placeholderLabel="Buscar producto o servicio..."
                  noEntriesFoundLabel="Sin resultados">
                </ngx-mat-select-search>
              </mat-option>

              <mat-option *ngIf="cargandoItems" [disabled]="true">
                Cargando ítems...
              </mat-option>

              <mat-option *ngFor="let it of itemsFiltrados" [value]="it.id">
                {{ it.descripcion }}
              </mat-option>
            </mat-select>

            <mat-error *ngIf="det.get('itemId')?.hasError('required')">
              Requerido
            </mat-error>
          </mat-form-field>
        </div>

        <!-- CANTIDAD COMERCIAL (hormas/cajas) -->
        <div class="col cantidad">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>
              Cantidad ({{ det.get('unidadComercial')?.value || '—' }})
            </mat-label>

            <input
              matInput
              type="number"
              formControlName="cantidadComercial"
              min="1"
              step="1" />

            <mat-error *ngIf="det.get('cantidadComercial')?.invalid">
              Ingresá una cantidad válida
            </mat-error>
          </mat-form-field>
        </div>

        <!-- CANTIDAD BASE (kg/unidades base) -->
        <div class="col cantidad">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>
              {{ det.get('unidadBase')?.value === 'KG'
                ? 'Peso (kg)'
                : 'Cantidad base (' + (det.get('unidadBase')?.value || '—') + ')' }}
            </mat-label>

            <input
              matInput
              type="number"
              formControlName="cantidad"
              [step]="det.get('unidadBase')?.value === 'KG' ? '0.01' : '1'"
              [min]="det.get('unidadBase')?.value === 'KG' ? '0.01' : '1'" />

            <mat-hint *ngIf="det.get('factorConversion')?.value">
              Estimado: {{ det.get('cantidadComercial')?.value || 0 }}
              × {{ det.get('factorConversion')?.value }}
              = {{ (det.get('cantidadComercial')?.value || 0) * (det.get('factorConversion')?.value || 0) | number:'1.2-2' }}
              {{ det.get('unidadBase')?.value }}
            </mat-hint>

            <mat-error *ngIf="det.get('cantidad')?.invalid">
              Ingresá un valor válido
            </mat-error>
          </mat-form-field>
        </div>

        <!-- PRECIO -->
        <div class="col precio">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Precio (por {{ det.get('unidadBase')?.value || '—' }})</mat-label>
            <input matInput type="number" formControlName="precioUnitario" />
          </mat-form-field>
        </div>

        <!-- SUBTOTAL -->
        <div class="col subtotal subtotal-text">
          {{ (det.get('cantidad')?.value || 0) * (det.get('precioUnitario')?.value || 0) | number:'1.2-2' }}
        </div>

        <!-- ACCIONES -->
        <div class="col acciones">
          <button mat-icon-button color="warn" type="button" (click)="quitarLinea(i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

      </div>
    </div>

    <div class="total-wrap">
      <div class="total-label">Total</div>
      <div class="total-valor">$ {{ total | number:'1.2-2' }}</div>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button type="button" (click)="cancelar()">Cancelar</button>
  <button mat-raised-button color="primary" type="button" (click)="guardar()"
          [disabled]="form.invalid || detalles.length === 0">
    Guardar
  </button>
</mat-dialog-actions>
