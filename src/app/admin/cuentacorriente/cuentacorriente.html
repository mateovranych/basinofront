<div class="cuenta-corriente-page">

    <mat-form-field appearance="outline" class="w-100">
        <mat-label>Cliente</mat-label>

        <mat-select [formControl]="clienteIdCtrl">
            <mat-option>
                <ngx-mat-select-search [formControl]="filtroClientesCtrl" placeholderLabel="Buscar cliente..."
                    noEntriesFoundLabel="Sin resultados">
                </ngx-mat-select-search>
            </mat-option>

            <mat-option *ngIf="cargandoClientes" [disabled]="true">
                Cargando clientes...
            </mat-option>

            <mat-option *ngFor="let c of clientesFiltrados" [value]="c.id">
                {{ c.razonSocial }}
            </mat-option>
        </mat-select>
    </mat-form-field>

    <div *ngIf="cuentaCorriente" class="saldo-box">
        <h3>
            Saldo total:
            <span [ngClass]="{
          'deuda': cuentaCorriente.saldoTotal > 0,
          'favor': cuentaCorriente.saldoTotal < 0
        }">
                {{ cuentaCorriente.saldoTotal | currency:'$' }}
            </span>
        </h3>
        <button mat-stroked-button color="primary" (click)="abrirHistorial()" [disabled]="!clienteIdCtrl.value">
            Ver historial
        </button>

    </div>

    <div *ngIf="cuentaCorriente?.presupuestos?.length">

        <table class="tabla-cc">
            <thead>
                <tr>
                    <th>Presupuesto</th>
                    <th>Fecha</th>
                    <th>Monto</th>
                    <th>Pagos</th>
                    <th>Saldo</th>
                    <th>Pagar</th>
                </tr>
            </thead>


            <tbody *ngIf="cuentaCorriente as cc">
                <tr *ngFor="let p of cc.presupuestos" (dblclick)="toggleSeleccion(p)"
                    [class.seleccionado]="p.seleccionado">

                    <td>#{{ p.presupuestoId }}</td>

                    <td class="fecha">
                        {{ p.fecha | date:'dd/MM/yyyy' }}
                    </td>

                    <td>{{ p.monto | currency }}</td>
                    <td>{{ p.pagos | currency }}</td>
                    <td><strong>{{ p.saldo | currency }}</strong></td>

                    <td class="pagar-col">
                        <input matInput type="number" placeholder="Monto" [(ngModel)]="p.montoPago" />

                        <button mat-icon-button color="primary" (click)="pagarPresupuesto(p)">
                            <mat-icon>check</mat-icon>
                        </button>
                    </td>
                </tr>
            </tbody>

        </table>

        <div class="panel-pago" *ngIf="presupuestosSeleccionados.length">

            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Observación del recibo</mat-label>
                <textarea matInput rows="2" [(ngModel)]="observacionPago"
                    placeholder="Ej: Pago contado, transferencia, efectivo…">
                </textarea>
            </mat-form-field>

            <div class="panel-info">
                <strong>Presupuestos:</strong>
                <span *ngFor="let p of presupuestosSeleccionados">
                    #{{ p.presupuestoId }}
                </span>
            </div>

            <div class="panel-total">
                Total a pagar:
                <strong>{{ totalSeleccionado | currency:'$' }}</strong>
            </div>

            <div class="panel-actions">
                <button mat-stroked-button color="warn" (click)="limpiarSeleccion()">
                    Cancelar
                </button>

                <button mat-raised-button color="primary" (click)="pagarSeleccionados()">
                    Confirmar pago
                </button>
            </div>
        </div>


    </div>

    <!-- ================= SIN DEUDA ================= -->
    <div *ngIf="cuentaCorriente && !cuentaCorriente.presupuestos.length">
        <p class="sin-deuda">
            El cliente no tiene deuda pendiente.
        </p>
    </div>

</div>