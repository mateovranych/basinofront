<div class="cuenta-corriente-page">

    <mat-form-field appearance="outline" class="w-100">
        <mat-label>Cliente</mat-label>

        <mat-select [formControl]="clienteIdCtrl">
            <mat-option>
                <ngx-mat-select-search [formControl]="filtroClientesCtrl" placeholderLabel="Buscar cliente..."
                    noEntriesFoundLabel="Sin resultados">
                </ngx-mat-select-search>
            </mat-option>

            <mat-option *ngIf="cargandoClientes" [disabled]="true">
                Cargando clientes...
            </mat-option>

            <mat-option *ngFor="let c of clientesFiltrados" [value]="c.id">
                {{ c.razonSocial }}
            </mat-option>
        </mat-select>
    </mat-form-field>

    <div *ngIf="cuentaCorriente" class="saldo-box">

        <h3>
            Saldo total:
            <span [ngClass]="{
          'deuda': cuentaCorriente.saldoTotal > 0,
          'favor': cuentaCorriente.saldoTotal < 0
        }">
                {{ cuentaCorriente.saldoTotal | currency:'$' }}
            </span>
        </h3>

        <button mat-stroked-button color="primary" (click)="abrirHistorial()" [disabled]="!clienteIdCtrl.value">
            Ver historial
        </button>

    </div>

    <div *ngIf="cuentaCorriente?.presupuestos?.length">

        <table class="tabla-cc">
            <thead>
                <tr>
                    <th>Presupuesto</th>
                    <th>Fecha</th>
                    <th>Monto</th>
                    <th>Pagos</th>
                    <th>Saldo</th>
                    <!-- <th>Pagar</th> -->
                </tr>
            </thead>


            <tbody *ngIf="cuentaCorriente as cc">
                <tr *ngFor="let p of cc.presupuestos" (dblclick)="toggleSeleccion(p)"
                    [class.seleccionado]="p.seleccionado">

                    <td>#{{ p.presupuestoId }}</td>

                    <td class="fecha">
                        {{ p.fecha | date:'dd/MM/yyyy' }}
                    </td>

                    <td>{{ p.monto | currency }}</td>
                    <td>{{ p.pagos | currency }}</td>
                    <td><strong>{{ p.saldo | currency }}</strong></td>
                </tr>
            </tbody>

        </table>

        <div class="panel-pago" *ngIf="presupuestosSeleccionados.length">

            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Observación del recibo</mat-label>
                <textarea matInput rows="2" [(ngModel)]="observacionPago"
                    placeholder="Ej: efectivo, transferencia, MP…">
        </textarea>
            </mat-form-field>

            <div class="panel-detalles">

                <div class="detalle-pago" *ngFor="let p of presupuestosSeleccionados">

                    <div class="detalle-info">
                        <strong>Presupuesto #{{ p.presupuestoId }}</strong>
                        <small>Saldo: {{ p.saldo | currency:'$' }}</small>
                    </div>

                    <mat-form-field appearance="outline" class="monto-field">
                        <mat-label>Monto a pagar</mat-label>
                        <input matInput type="number" min="1" [max]="p.saldo" [(ngModel)]="p.montoPago" (keydown)="bloquearFlechas($event)" >
                    </mat-form-field>

                </div>

            </div>

            <div class="panel-total">
                Total a pagar:
                <strong>{{ totalSeleccionado | currency:'$' }}</strong>
            </div>

            <div class="panel-actions">
                <button mat-stroked-button color="warn" (click)="limpiarSeleccion()">
                    Cancelar
                </button>

                <button mat-raised-button color="primary" [disabled]="pagando" (click)="pagarSeleccionados()">
                    Confirmar pago
                </button>
            </div>

        </div>

    </div>

    <div *ngIf="cuentaCorriente && !cuentaCorriente.presupuestos.length">
        <p class="sin-deuda">
            El cliente no tiene deuda pendiente.
        </p>
    </div>

</div>